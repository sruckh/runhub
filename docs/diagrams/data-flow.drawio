<mxGraphModel>
  <root>
    <mxCell id="0"/>
    <mxCell id="1" parent="0"/>

    <!-- Title -->
    <mxCell id="2" value="iMontage RunningHub — Data Flow" style="text;html=1;fontSize=18;fontStyle=1;align=center;verticalAlign=middle;fillColor=none;strokeColor=none;fontColor=#1e293b;" vertex="1" parent="1">
      <mxGeometry x="120" y="10" width="560" height="30" as="geometry"/>
    </mxCell>

    <!-- Step 1: User Input -->
    <mxCell id="10" value="&lt;b&gt;1. User Input&lt;/b&gt;&lt;br&gt;LoRA URL, Subject,&lt;br&gt;Aspect Ratio, API Keys" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;fontSize=11;" vertex="1" parent="1">
      <mxGeometry x="40" y="60" width="150" height="70" as="geometry"/>
    </mxCell>

    <!-- Step 2: Scenario Selection -->
    <mxCell id="11" value="&lt;b&gt;2. Random Scenario&lt;/b&gt;&lt;br&gt;Pick 1 of 10&lt;br&gt;curated scenarios" style="shape=hexagon;perimeter=hexagonPerimeter2;whiteSpace=wrap;html=1;fixedSize=1;size=15;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=11;" vertex="1" parent="1">
      <mxGeometry x="230" y="60" width="155" height="70" as="geometry"/>
    </mxCell>

    <!-- Step 3: Gemini Prompt Gen -->
    <mxCell id="12" value="&lt;b&gt;3. Gemini LLM&lt;/b&gt;&lt;br&gt;Generate detailed&lt;br&gt;FLUX.1-dev prompt" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;fontSize=11;" vertex="1" parent="1">
      <mxGeometry x="425" y="60" width="155" height="70" as="geometry"/>
    </mxCell>

    <!-- Step 4: Dimension Calc -->
    <mxCell id="13" value="&lt;b&gt;4. Calculate&lt;/b&gt;&lt;br&gt;Dimensions&lt;br&gt;(16px aligned)" style="shape=hexagon;perimeter=hexagonPerimeter2;whiteSpace=wrap;html=1;fixedSize=1;size=15;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=11;" vertex="1" parent="1">
      <mxGeometry x="620" y="60" width="140" height="70" as="geometry"/>
    </mxCell>

    <!-- Step 5: RunningHub Submit -->
    <mxCell id="14" value="&lt;b&gt;5. Submit to RunningHub&lt;/b&gt;&lt;br&gt;Prompt + LoRA + Dimensions&lt;br&gt;→ taskId returned" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;fontSize=11;" vertex="1" parent="1">
      <mxGeometry x="50" y="200" width="195" height="70" as="geometry"/>
    </mxCell>

    <!-- Step 6: Poll Loop -->
    <mxCell id="15" value="&lt;b&gt;6. Poll Status&lt;/b&gt;&lt;br&gt;Every 5 seconds&lt;br&gt;/openapi/v2/query" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=11;" vertex="1" parent="1">
      <mxGeometry x="300" y="200" width="155" height="70" as="geometry"/>
    </mxCell>

    <!-- Decision Diamond -->
    <mxCell id="16" value="Status?" style="rhombus;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=11;fontStyle=1;" vertex="1" parent="1">
      <mxGeometry x="520" y="195" width="100" height="80" as="geometry"/>
    </mxCell>

    <!-- Step 7a: Download -->
    <mxCell id="17" value="&lt;b&gt;7. Download Image&lt;/b&gt;&lt;br&gt;Fetch from RunningHub&lt;br&gt;Save to /mount/" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=11;" vertex="1" parent="1">
      <mxGeometry x="440" y="330" width="165" height="70" as="geometry"/>
    </mxCell>

    <!-- Step 7b: Back to poll -->
    <mxCell id="18" value="PROCESSING" style="text;html=1;fontSize=10;fontStyle=2;align=center;fillColor=none;strokeColor=none;fontColor=#6c8ebf;" vertex="1" parent="1">
      <mxGeometry x="640" y="175" width="90" height="20" as="geometry"/>
    </mxCell>

    <!-- Step 8: Serve Image -->
    <mxCell id="19" value="&lt;b&gt;8. Serve to UI&lt;/b&gt;&lt;br&gt;/api/images/[...path]&lt;br&gt;Display in results" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=11;" vertex="1" parent="1">
      <mxGeometry x="190" y="330" width="165" height="70" as="geometry"/>
    </mxCell>

    <!-- Final: User sees result -->
    <mxCell id="29" value="&lt;b&gt;Result&lt;/b&gt;&lt;br&gt;Image + Prompt&lt;br&gt;displayed in UI" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;fontSize=11;" vertex="1" parent="1">
      <mxGeometry x="40" y="440" width="150" height="70" as="geometry"/>
    </mxCell>

    <!-- Arrows -->
    <mxCell id="a1" style="endArrow=classic;strokeColor=#666;curved=1;" edge="1" parent="1" source="10" target="11">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>

    <mxCell id="a2" style="endArrow=classic;strokeColor=#666;curved=1;" edge="1" parent="1" source="11" target="12">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>
    <mxCell id="a2l" value="Subject + Scenario" style="edgeLabel;html=1;fontSize=9;fontColor=#666;" vertex="1" connectable="0" parent="a2">
      <mxGeometry x="-0.1" relative="1" as="geometry"><mxPoint as="offset"/></mxGeometry>
    </mxCell>

    <mxCell id="a3" style="endArrow=classic;strokeColor=#666;curved=1;" edge="1" parent="1" source="12" target="13">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>
    <mxCell id="a3l" value="FLUX prompt" style="edgeLabel;html=1;fontSize=9;fontColor=#666;" vertex="1" connectable="0" parent="a3">
      <mxGeometry x="-0.1" relative="1" as="geometry"><mxPoint as="offset"/></mxGeometry>
    </mxCell>

    <mxCell id="a4" style="endArrow=classic;strokeColor=#d79b00;curved=1;exitX=0;exitY=1;entryX=1;entryY=0;" edge="1" parent="1" source="13" target="14">
      <mxGeometry relative="1" as="geometry">
        <Array as="points"><mxPoint x="620" y="170"/><mxPoint x="300" y="170"/></Array>
      </mxGeometry>
    </mxCell>
    <mxCell id="a4l" value="Payload (prompt, LoRA, W×H, seed)" style="edgeLabel;html=1;fontSize=9;fontColor=#d79b00;" vertex="1" connectable="0" parent="a4">
      <mxGeometry x="-0.1" relative="1" as="geometry"><mxPoint as="offset"/></mxGeometry>
    </mxCell>

    <mxCell id="a5" style="endArrow=classic;strokeColor=#666;curved=1;" edge="1" parent="1" source="14" target="15">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>
    <mxCell id="a5l" value="taskId" style="edgeLabel;html=1;fontSize=9;fontColor=#666;" vertex="1" connectable="0" parent="a5">
      <mxGeometry x="-0.1" relative="1" as="geometry"><mxPoint as="offset"/></mxGeometry>
    </mxCell>

    <mxCell id="a6" style="endArrow=classic;strokeColor=#666;curved=1;" edge="1" parent="1" source="15" target="16">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>

    <!-- Decision: SUCCESS -->
    <mxCell id="a7" style="endArrow=classic;strokeColor=#82b366;curved=1;exitX=0.5;exitY=1;entryX=0.5;entryY=0;" edge="1" parent="1" source="16" target="17">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>
    <mxCell id="a7l" value="SUCCESS" style="edgeLabel;html=1;fontSize=9;fontColor=#82b366;fontStyle=1;" vertex="1" connectable="0" parent="a7">
      <mxGeometry x="-0.2" relative="1" as="geometry"><mxPoint as="offset"/></mxGeometry>
    </mxCell>

    <!-- Decision: PROCESSING loop back -->
    <mxCell id="a8" style="endArrow=classic;strokeColor=#6c8ebf;curved=1;dashed=1;exitX=1;exitY=0.5;entryX=1;entryY=0.5;" edge="1" parent="1" source="16" target="15">
      <mxGeometry relative="1" as="geometry">
        <Array as="points"><mxPoint x="680" y="235"/><mxPoint x="680" y="280"/><mxPoint x="500" y="280"/><mxPoint x="500" y="235"/></Array>
      </mxGeometry>
    </mxCell>
    <mxCell id="a8l" value="Wait 5s" style="edgeLabel;html=1;fontSize=9;fontColor=#6c8ebf;fontStyle=2;" vertex="1" connectable="0" parent="a8">
      <mxGeometry x="0.3" relative="1" as="geometry"><mxPoint as="offset"/></mxGeometry>
    </mxCell>

    <!-- Download to Serve -->
    <mxCell id="a9" style="endArrow=classic;strokeColor=#666;curved=1;" edge="1" parent="1" source="17" target="19">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>
    <mxCell id="a9l" value="PNG saved" style="edgeLabel;html=1;fontSize=9;fontColor=#666;" vertex="1" connectable="0" parent="a9">
      <mxGeometry x="-0.1" relative="1" as="geometry"><mxPoint as="offset"/></mxGeometry>
    </mxCell>

    <!-- Serve to User -->
    <mxCell id="a10" style="endArrow=classic;strokeColor=#666;curved=1;exitX=0;exitY=1;entryX=1;entryY=0;" edge="1" parent="1" source="19" target="29">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>
    <mxCell id="a10l" value="Image + Prompt" style="edgeLabel;html=1;fontSize=9;fontColor=#666;" vertex="1" connectable="0" parent="a10">
      <mxGeometry x="-0.1" relative="1" as="geometry"><mxPoint as="offset"/></mxGeometry>
    </mxCell>

  </root>
</mxGraphModel>