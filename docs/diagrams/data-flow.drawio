<mxGraphModel>
  <root>
    <mxCell id="0"/>
    <mxCell id="1" parent="0"/>

    <!-- Title -->
    <mxCell id="title" value="iMontage RunningHub — Request Flow" style="text;html=1;fontSize=18;fontStyle=1;align=center;verticalAlign=middle;fillColor=none;strokeColor=none;fontColor=#333333;" vertex="1" parent="1">
      <mxGeometry x="120" y="10" width="560" height="30" as="geometry"/>
    </mxCell>

    <!-- Step 1: User Input -->
    <mxCell id="s1" value="&lt;b&gt;1. User Input&lt;/b&gt;&lt;br&gt;&lt;i&gt;Subject, LoRA URL,&lt;br&gt;Aspect Ratio, API Keys,&lt;br&gt;Batch Size (1-50)&lt;/i&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;fontSize=11;" vertex="1" parent="1">
      <mxGeometry x="40" y="60" width="160" height="80" as="geometry"/>
    </mxCell>

    <!-- Step 2: Scenario Selection -->
    <mxCell id="s2" value="&lt;b&gt;2. Random Scenario&lt;/b&gt;&lt;br&gt;&lt;i&gt;1 of 10 curated&lt;br&gt;photographic scenarios&lt;/i&gt;" style="rhombus;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=11;" vertex="1" parent="1">
      <mxGeometry x="240" y="50" width="170" height="100" as="geometry"/>
    </mxCell>

    <!-- Step 3: Gemini Prompt -->
    <mxCell id="s3" value="&lt;b&gt;3. Gemini Prompt Gen&lt;/b&gt;&lt;br&gt;&lt;i&gt;Subject + Scenario →&lt;br&gt;FLUX.1-dev prompt&lt;br&gt;(temp 1.3, topP 0.95)&lt;/i&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;fontSize=11;" vertex="1" parent="1">
      <mxGeometry x="450" y="60" width="160" height="80" as="geometry"/>
    </mxCell>

    <!-- Step 4: Dimension Calc -->
    <mxCell id="s4" value="&lt;b&gt;4. Dimension Calc&lt;/b&gt;&lt;br&gt;&lt;i&gt;Aspect ratio →&lt;br&gt;16px-aligned W×H&lt;/i&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=11;" vertex="1" parent="1">
      <mxGeometry x="650" y="60" width="130" height="80" as="geometry"/>
    </mxCell>

    <!-- Step 5: RunningHub Submit -->
    <mxCell id="s5" value="&lt;b&gt;5. RunningHub Submit&lt;/b&gt;&lt;br&gt;&lt;i&gt;Prompt + LoRA + Dims&lt;br&gt;+ Random Seed&lt;br&gt;→ taskId returned&lt;/i&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;fontSize=11;" vertex="1" parent="1">
      <mxGeometry x="40" y="210" width="160" height="80" as="geometry"/>
    </mxCell>

    <!-- Step 6: Poll Loop -->
    <mxCell id="s6" value="&lt;b&gt;6. Poll Status&lt;/b&gt;&lt;br&gt;&lt;i&gt;POST /api/check&lt;br&gt;every 5 seconds&lt;/i&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=11;" vertex="1" parent="1">
      <mxGeometry x="250" y="210" width="150" height="80" as="geometry"/>
    </mxCell>

    <!-- Decision: Status -->
    <mxCell id="d1" value="&lt;b&gt;Status?&lt;/b&gt;" style="rhombus;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=12;fontStyle=1;" vertex="1" parent="1">
      <mxGeometry x="460" y="215" width="120" height="70" as="geometry"/>
    </mxCell>

    <!-- PROCESSING loop back -->
    <mxCell id="s_processing" value="PROCESSING" style="text;html=1;fontSize=10;fontStyle=2;fontColor=#6c8ebf;align=center;" vertex="1" parent="1">
      <mxGeometry x="370" y="170" width="90" height="20" as="geometry"/>
    </mxCell>

    <!-- Step 7: Download & Save -->
    <mxCell id="s7" value="&lt;b&gt;7. Download &amp; Save&lt;/b&gt;&lt;br&gt;&lt;i&gt;Fetch image URL&lt;br&gt;Save to /mount/{dir}/&lt;br&gt;{prefix}_NNN.png&lt;/i&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=11;" vertex="1" parent="1">
      <mxGeometry x="250" y="350" width="160" height="80" as="geometry"/>
    </mxCell>

    <!-- Step 8: Display -->
    <mxCell id="s8" value="&lt;b&gt;8. Display Result&lt;/b&gt;&lt;br&gt;&lt;i&gt;Thumbnail + prompt&lt;br&gt;in results feed&lt;br&gt;Click → fullscreen&lt;/i&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;fontSize=11;" vertex="1" parent="1">
      <mxGeometry x="500" y="350" width="150" height="80" as="geometry"/>
    </mxCell>

    <!-- Failed -->
    <mxCell id="s_failed" value="&lt;b&gt;Failed&lt;/b&gt;&lt;br&gt;&lt;i&gt;Error badge&lt;/i&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;fontSize=11;" vertex="1" parent="1">
      <mxGeometry x="640" y="215" width="110" height="60" as="geometry"/>
    </mxCell>

    <!-- Batch Loop indicator -->
    <mxCell id="batch" value="&lt;b&gt;Batch Loop&lt;/b&gt;&lt;br&gt;&lt;i&gt;Repeat steps 2-8&lt;br&gt;for each of N prompts&lt;br&gt;(sequential)&lt;/i&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=11;dashed=1;dashPattern=8 4;" vertex="1" parent="1">
      <mxGeometry x="40" y="360" width="150" height="70" as="geometry"/>
    </mxCell>

    <!-- EDGES -->

    <!-- 1 -> 2 -->
    <mxCell id="e1" style="edgeStyle=orthogonalEdgeStyle;curved=1;endArrow=classic;strokeColor=#333333;" edge="1" source="s1" target="s2" parent="1">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>

    <!-- 2 -> 3 -->
    <mxCell id="e2" style="edgeStyle=orthogonalEdgeStyle;curved=1;endArrow=classic;strokeColor=#333333;" edge="1" source="s2" target="s3" parent="1">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>

    <!-- 3 -> 4 -->
    <mxCell id="e3" style="edgeStyle=orthogonalEdgeStyle;curved=1;endArrow=classic;strokeColor=#333333;" edge="1" source="s3" target="s4" parent="1">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>

    <!-- 4 -> 5 (wrap down) -->
    <mxCell id="e4" style="edgeStyle=orthogonalEdgeStyle;curved=1;endArrow=classic;strokeColor=#333333;exitX=0.5;exitY=1;entryX=1;entryY=0;" edge="1" source="s4" target="s5" parent="1">
      <mxGeometry relative="1" as="geometry">
        <Array as="points">
          <mxPoint x="715" y="170"/>
          <mxPoint x="200" y="170"/>
        </Array>
      </mxGeometry>
    </mxCell>

    <!-- 5 -> 6 -->
    <mxCell id="e5" style="edgeStyle=orthogonalEdgeStyle;curved=1;endArrow=classic;strokeColor=#333333;" edge="1" source="s5" target="s6" parent="1">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>

    <!-- 6 -> Decision -->
    <mxCell id="e6" style="edgeStyle=orthogonalEdgeStyle;curved=1;endArrow=classic;strokeColor=#333333;" edge="1" source="s6" target="d1" parent="1">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>

    <!-- Decision -> Poll loop (PROCESSING) -->
    <mxCell id="e7" value="" style="edgeStyle=orthogonalEdgeStyle;curved=1;endArrow=classic;strokeColor=#6c8ebf;dashed=1;exitX=0.5;exitY=0;entryX=0.5;entryY=0;" edge="1" source="d1" target="s6" parent="1">
      <mxGeometry relative="1" as="geometry">
        <Array as="points">
          <mxPoint x="520" y="185"/>
          <mxPoint x="325" y="185"/>
        </Array>
      </mxGeometry>
    </mxCell>

    <!-- Decision -> Download (SUCCESS) -->
    <mxCell id="e8" value="SUCCESS" style="edgeStyle=orthogonalEdgeStyle;curved=1;endArrow=classic;strokeColor=#82b366;fontSize=9;fontStyle=1;exitX=0.5;exitY=1;entryX=0.5;entryY=0;" edge="1" source="d1" target="s7" parent="1">
      <mxGeometry relative="1" as="geometry">
        <Array as="points">
          <mxPoint x="520" y="320"/>
          <mxPoint x="330" y="320"/>
        </Array>
      </mxGeometry>
    </mxCell>

    <!-- Decision -> Failed -->
    <mxCell id="e9" value="FAILED" style="edgeStyle=orthogonalEdgeStyle;curved=1;endArrow=classic;strokeColor=#b85450;fontSize=9;fontStyle=1;exitX=1;exitY=0.5;entryX=0;entryY=0.5;" edge="1" source="d1" target="s_failed" parent="1">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>

    <!-- Download -> Display -->
    <mxCell id="e10" value="/api/images" style="edgeStyle=orthogonalEdgeStyle;curved=1;endArrow=classic;strokeColor=#333333;fontSize=9;" edge="1" source="s7" target="s8" parent="1">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>

    <!-- Display -> Batch loop -->
    <mxCell id="e11" value="Next in queue" style="edgeStyle=orthogonalEdgeStyle;curved=1;endArrow=classic;strokeColor=#d6b656;dashed=1;fontSize=9;exitX=0.5;exitY=1;entryX=0.5;entryY=1;" edge="1" source="s8" target="batch" parent="1">
      <mxGeometry relative="1" as="geometry">
        <Array as="points">
          <mxPoint x="575" y="460"/>
          <mxPoint x="115" y="460"/>
        </Array>
      </mxGeometry>
    </mxCell>

  </root>
</mxGraphModel>